#cloud-config

users:
- name: funnel
  uid: 4949
  groups: docker
  system: true

write_files:
- path: /etc/systemd/system/funnel.service
  permissions: 0644
  owner: root
  content: |
    [Unit]
    Description=Start a Funnel node

    [Service]
    Environment=DOCKER_GROUP_ID=412
    ExecStart=/usr/bin/docker run \
      -u 4949 \
      --group-add ${DOCKER_GROUP_ID} \
      --name funnel \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -v /usr/bin/docker:/usr/bin/docker \
      -v /mnt/stateful_partition/funnel:/mnt/stateful_partition/funnel \
      -w /mnt/stateful_partition/funnel \
      docker.io/buchanaeohsu/funnel:smcrna \
      gce node
    ExecStop=/usr/bin/docker stop funnel
    ExecStopPost=/usr/bin/docker rm funnel

runcmd:
- mkdir /mnt/stateful_partition/funnel
- chown funnel:funnel /mnt/stateful_partition/funnel
- usermod -aG docker funnel
- docker pull docker.io/buchanaeohsu/funnel:smcrna
- systemctl daemon-reload
- systemctl start funnel.service
